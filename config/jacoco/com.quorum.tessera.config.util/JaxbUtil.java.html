<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JaxbUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">config</a> &gt; <a href="index.source.html" class="el_package">com.quorum.tessera.config.util</a> &gt; <span class="el_source">JaxbUtil.java</span></div><h1>JaxbUtil.java</h1><pre class="source lang-java linenums">package com.quorum.tessera.config.util;

import com.quorum.tessera.config.*;
import java.io.ByteArrayOutputStream;

import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Marshaller;
import javax.xml.bind.Unmarshaller;
import javax.xml.transform.stream.StreamSource;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.Objects;
import java.util.Optional;
import javax.validation.ConstraintViolationException;

public interface JaxbUtil {

<span class="fc" id="L19">    Class[] JAXB_CLASSES = new Class[]{</span>
        Config.class,
        KeyDataConfig.class,
        PrivateKeyData.class,
        ArgonOptions.class,
        JdbcConfig.class,
        KeyData.class,
        Peer.class,
        PrivateKeyType.class,
        ServerConfig.class,
        SslAuthenticationMode.class,
        SslConfig.class,
        SslTrustMode.class
    };

    static &lt;T&gt; T unmarshal(InputStream inputStream, Class&lt;T&gt; type) {

        try {
<span class="fc" id="L37">            JAXBContext jaxbContext = JAXBContext.newInstance(JAXB_CLASSES);</span>
<span class="fc" id="L38">            Unmarshaller unmarshaller = jaxbContext.createUnmarshaller();</span>
<span class="fc" id="L39">            unmarshaller.setProperty(&quot;eclipselink.media-type&quot;, &quot;application/json&quot;);</span>
<span class="fc" id="L40">            unmarshaller.setProperty(&quot;eclipselink.json.include-root&quot;, false);</span>

<span class="fc" id="L42">            return unmarshaller.unmarshal(new StreamSource(inputStream), type).getValue();</span>
<span class="fc" id="L43">        } catch (JAXBException ex) {</span>
<span class="fc" id="L44">            throw new ConfigException(ex);</span>
        }
    }

    static void marshal(Object object, OutputStream outputStream) {
        try {
<span class="fc" id="L50">            JAXBContext jaxbContext = JAXBContext.newInstance(JAXB_CLASSES);</span>
<span class="fc" id="L51">            Marshaller marshaller = jaxbContext.createMarshaller();</span>
<span class="fc" id="L52">            marshaller.setProperty(&quot;eclipselink.media-type&quot;, &quot;application/json&quot;);</span>
<span class="fc" id="L53">            marshaller.setProperty(&quot;eclipselink.json.include-root&quot;, false);</span>
<span class="fc" id="L54">            marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);</span>

<span class="fc" id="L56">            marshaller.marshal(object, outputStream);</span>
<span class="fc" id="L57">        }  catch(Throwable ex) {</span>
<span class="fc" id="L58">          Optional&lt;ConstraintViolationException&gt; validationException =   unwrapConstraintViolationException(ex);</span>
<span class="fc bfc" id="L59" title="All 2 branches covered.">          if(validationException.isPresent()) {</span>
<span class="fc" id="L60">              throw validationException.get();</span>
          }
<span class="fc" id="L62">          throw new ConfigException(ex);</span>
<span class="fc" id="L63">        }</span>

<span class="fc" id="L65">    }</span>

    static void marshalWithNoValidation(Object object, OutputStream outputStream) {
        try {

<span class="fc" id="L70">            JAXBContext jaxbContext = JAXBContext.newInstance(JAXB_CLASSES);</span>
<span class="fc" id="L71">            Marshaller marshaller = jaxbContext.createMarshaller();</span>
<span class="fc" id="L72">            marshaller.setProperty(&quot;eclipselink.media-type&quot;, &quot;application/json&quot;);</span>
            //Workaround so not to require eclipselink compile time dependency.
            //Resolve BeanValidationMode from default value and set to NONE
            //org.eclipse.persistence.jaxb.BeanValidationMode
<span class="fc" id="L76">            Enum enu = Enum.valueOf(Class.class.cast(marshaller</span>
<span class="fc" id="L77">                    .getProperty(&quot;eclipselink.beanvalidation.mode&quot;)</span>
<span class="fc" id="L78">                    .getClass()), &quot;NONE&quot;);</span>

<span class="fc" id="L80">            marshaller.setProperty(&quot;eclipselink.beanvalidation.mode&quot;, enu);</span>
<span class="fc" id="L81">            marshaller.setProperty(&quot;eclipselink.json.include-root&quot;, false);</span>
<span class="fc" id="L82">            marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);</span>
<span class="fc" id="L83">            marshaller.marshal(object, outputStream);</span>
<span class="fc" id="L84">        } catch (JAXBException ex) {</span>
<span class="fc" id="L85">            throw new ConfigException(ex);</span>
<span class="fc" id="L86">        }</span>
<span class="fc" id="L87">    }</span>

    static String marshalToString(Object object) {
<span class="fc" id="L90">        return IOCallback.execute(() -&gt; {</span>
<span class="fc" id="L91">            try (OutputStream out = new ByteArrayOutputStream()) {</span>
<span class="fc" id="L92">                marshal(object, out);</span>
<span class="fc" id="L93">                return out.toString();</span>
            }
        });
    }

    static String marshalToStringNoValidation(Object object) {
<span class="fc" id="L99">        return IOCallback.execute(() -&gt; {</span>
<span class="fc" id="L100">            try (OutputStream out = new ByteArrayOutputStream()) {</span>
<span class="fc" id="L101">                marshalWithNoValidation(object, out);</span>
<span class="fc" id="L102">                return out.toString();</span>
            }
        });
    }
    
    static Optional&lt;ConstraintViolationException&gt; unwrapConstraintViolationException(Throwable ex) {
<span class="fc" id="L108">        return Optional.of(ex)</span>
<span class="fc" id="L109">                .map(Throwable::getCause)</span>
<span class="fc" id="L110">                .filter(Objects::nonNull)</span>
<span class="fc" id="L111">                .filter(ConstraintViolationException.class::isInstance)</span>
<span class="fc" id="L112">                .map(ConstraintViolationException.class::cast);</span>
    }
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>